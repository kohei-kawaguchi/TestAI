---
title: "Difference-in-Differences Multi-Period Data Analysis"
author: "Data Description Report"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(tidyverse)
library(knitr)
library(kableExtra)
library(here)
```

# Overview

This report describes the difference-in-differences multi-period datasets located in `output/difference_in_differences_multiperiods/`.

## Data Context

The datasets contain panel data with **staggered treatment adoption**:

- **Panel structure**: Multiple units observed over multiple time periods
- **Staggered interventions**: Different units receive treatment at different time points (periods 5, 6, 7, 8)
- **Covariates**: Unit-level covariates (x1_i, x2_i) that affect both treatment assignment (selection) and outcomes
- **Treatment persistence**: Once treated, units remain treated in subsequent periods

## Analysis Plan

### Objective
Estimate the **Average Treatment Effect on the Treated (ATT)** accounting for:
1. Staggered treatment timing across units
2. Selection on observables (covariate confounding)

### Method: Callaway and Sant'Anna (2021)

We will use the **`did`** R package, which implements the Callaway and Sant'Anna (2021) estimator for difference-in-differences with multiple time periods.

**Key features of this method:**

1. **Group-Time ATT**: Estimates treatment effects for each treatment cohort (group) at each time period
2. **Covariate adjustment**: Incorporates covariates to satisfy conditional parallel trends assumption
3. **Three estimator options**:
   - Outcome regression
   - Inverse probability weighting (IPW)
   - Doubly robust (default - combines both)
4. **Proper comparison groups**: Uses not-yet-treated or never-treated units as controls
5. **Aggregation flexibility**: Can aggregate to overall ATT, event study effects, group-specific effects, or calendar time effects

**Required variables:**

- `yname`: Outcome variable (y_it)
- `tname`: Time period (time)
- `idname`: Unit identifier (id)
- `gname`: Treatment timing group (first period of treatment; 0 if never treated)
- `xformla`: Covariate formula (~x1_i + x2_i)

**Main functions:**

- `att_gt()`: Estimates group-time average treatment effects
- `aggte()`: Aggregates group-time effects into summary measures
- `ggdid()`: Visualizes results

# Load Data

```{r load-data}
# Load the three datasets
df_cov <- readRDS(here("output/difference_in_differences_multiperiods/df_design_cov.rds"))
df_nocov <- readRDS(here("output/difference_in_differences_multiperiods/df_design_nocov.rds"))
df_nyt <- readRDS(here("output/difference_in_differences_multiperiods/df_design_nyt.rds"))
```

# Dataset 1: With Covariates (df_design_cov)

## Structure

```{r cov-structure}
str(df_cov)
```

## Summary Statistics

### Numeric Variables

```{r cov-summary-numeric}
numeric_vars <- df_cov %>% select(where(is.numeric))
if(ncol(numeric_vars) > 0) {
  numeric_summary <- data.frame(
    Variable = names(numeric_vars),
    Min = sapply(numeric_vars, min, na.rm = TRUE),
    Q1 = sapply(numeric_vars, quantile, 0.25, na.rm = TRUE),
    Median = sapply(numeric_vars, median, na.rm = TRUE),
    Mean = sapply(numeric_vars, mean, na.rm = TRUE),
    Q3 = sapply(numeric_vars, quantile, 0.75, na.rm = TRUE),
    Max = sapply(numeric_vars, max, na.rm = TRUE),
    SD = sapply(numeric_vars, sd, na.rm = TRUE),
    N_Missing = sapply(numeric_vars, function(x) sum(is.na(x)))
  )
  rownames(numeric_summary) <- NULL

  numeric_summary %>%
    kable(digits = 3) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
}
```

### Logical Variables

```{r cov-summary-logical}
logical_vars <- df_cov %>% select(where(is.logical))
if(ncol(logical_vars) > 0) {
  logical_summary <- data.frame(
    Variable = names(logical_vars),
    N_TRUE = sapply(logical_vars, function(x) sum(x, na.rm = TRUE)),
    N_FALSE = sapply(logical_vars, function(x) sum(!x, na.rm = TRUE)),
    N_Missing = sapply(logical_vars, function(x) sum(is.na(x))),
    Prop_TRUE = sapply(logical_vars, function(x) mean(x, na.rm = TRUE))
  )
  rownames(logical_summary) <- NULL

  logical_summary %>%
    kable(digits = 3) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
}
```

### Character Variables

```{r cov-summary-character}
character_vars <- df_cov %>% select(where(is.character))
if(ncol(character_vars) > 0) {
  character_summary <- data.frame(
    Variable = names(character_vars),
    N_Unique = sapply(character_vars, function(x) length(unique(x))),
    N_Missing = sapply(character_vars, function(x) sum(is.na(x) | x == "")),
    Most_Common = sapply(character_vars, function(x) {
      tbl <- table(x)
      if(length(tbl) > 0) names(tbl)[which.max(tbl)] else NA
    }),
    Most_Common_Count = sapply(character_vars, function(x) {
      tbl <- table(x)
      if(length(tbl) > 0) max(tbl) else NA
    })
  )
  rownames(character_summary) <- NULL

  character_summary %>%
    kable(digits = 3) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
}
```

## Dimensions

```{r cov-dimensions}
cat("Number of observations:", nrow(df_cov), "\n")
cat("Number of variables:", ncol(df_cov), "\n")
```

## First Few Rows

```{r cov-head}
head(df_cov, 10) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  scroll_box(width = "100%")
```

## Variable Distribution

```{r cov-distributions, fig.width=10, fig.height=8}
# Select numeric variables for plotting
numeric_vars <- df_cov %>% select(where(is.numeric))

if(ncol(numeric_vars) > 0) {
  numeric_vars %>%
    pivot_longer(everything(), names_to = "variable", values_to = "value") %>%
    ggplot(aes(x = value)) +
    geom_histogram(bins = 30, fill = "steelblue", alpha = 0.7) +
    facet_wrap(~variable, scales = "free") +
    theme_minimal() +
    labs(title = "Distribution of Numeric Variables (df_design_cov)")
}
```

## ATT Estimation using Callaway and Sant'Anna (2021)

### Estimate Group-Time ATT

```{r cov-att-estimation}
library(did)

# Estimate group-time average treatment effects
# Using doubly robust estimator with covariates
att_results <- att_gt(
  yname = "y_it",           # Outcome variable
  tname = "time",            # Time period
  idname = "id",             # Unit identifier
  gname = "group_i",         # Treatment timing (0 for never-treated)
  xformla = ~x1_i + x2_i,    # Covariates
  data = df_cov,
  control_group = "nevertreated",  # Use never-treated as comparison
  est_method = "dr"          # Doubly robust estimator
)

# Display summary
summary(att_results)
```

### Aggregate to Overall ATT

```{r cov-att-simple}
# Simple weighted average ATT
att_simple <- aggte(att_results, type = "simple")
summary(att_simple)
```

### Event Study / Dynamic Effects

```{r cov-att-dynamic, fig.width=10, fig.height=6}
# Dynamic treatment effects (event study)
att_dynamic <- aggte(att_results, type = "dynamic")
summary(att_dynamic)

# Plot event study
ggdid(att_dynamic, title = "Event Study: Dynamic Treatment Effects")
```

### Group-Specific ATT

```{r cov-att-group, fig.width=10, fig.height=6}
# Group-specific average treatment effects
att_group <- aggte(att_results, type = "group")
summary(att_group)

# Plot group-specific effects
ggdid(att_group, title = "Average Treatment Effects by Treatment Cohort")
```

### Calendar Time Effects

```{r cov-att-calendar, fig.width=10, fig.height=6}
# Calendar time average treatment effects
att_calendar <- aggte(att_results, type = "calendar")
summary(att_calendar)

# Plot calendar time effects
ggdid(att_calendar, title = "Average Treatment Effects by Calendar Time")
```

---

# Dataset 2: Without Covariates (df_design_nocov)

## Structure

```{r nocov-structure}
str(df_nocov)
```

## Summary Statistics

### Numeric Variables

```{r nocov-summary-numeric}
numeric_vars <- df_nocov %>% select(where(is.numeric))
if(ncol(numeric_vars) > 0) {
  numeric_summary <- data.frame(
    Variable = names(numeric_vars),
    Min = sapply(numeric_vars, min, na.rm = TRUE),
    Q1 = sapply(numeric_vars, quantile, 0.25, na.rm = TRUE),
    Median = sapply(numeric_vars, median, na.rm = TRUE),
    Mean = sapply(numeric_vars, mean, na.rm = TRUE),
    Q3 = sapply(numeric_vars, quantile, 0.75, na.rm = TRUE),
    Max = sapply(numeric_vars, max, na.rm = TRUE),
    SD = sapply(numeric_vars, sd, na.rm = TRUE),
    N_Missing = sapply(numeric_vars, function(x) sum(is.na(x)))
  )
  rownames(numeric_summary) <- NULL

  numeric_summary %>%
    kable(digits = 3) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
}
```

### Logical Variables

```{r nocov-summary-logical}
logical_vars <- df_nocov %>% select(where(is.logical))
if(ncol(logical_vars) > 0) {
  logical_summary <- data.frame(
    Variable = names(logical_vars),
    N_TRUE = sapply(logical_vars, function(x) sum(x, na.rm = TRUE)),
    N_FALSE = sapply(logical_vars, function(x) sum(!x, na.rm = TRUE)),
    N_Missing = sapply(logical_vars, function(x) sum(is.na(x))),
    Prop_TRUE = sapply(logical_vars, function(x) mean(x, na.rm = TRUE))
  )
  rownames(logical_summary) <- NULL

  logical_summary %>%
    kable(digits = 3) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
}
```

### Character Variables

```{r nocov-summary-character}
character_vars <- df_nocov %>% select(where(is.character))
if(ncol(character_vars) > 0) {
  character_summary <- data.frame(
    Variable = names(character_vars),
    N_Unique = sapply(character_vars, function(x) length(unique(x))),
    N_Missing = sapply(character_vars, function(x) sum(is.na(x) | x == "")),
    Most_Common = sapply(character_vars, function(x) {
      tbl <- table(x)
      if(length(tbl) > 0) names(tbl)[which.max(tbl)] else NA
    }),
    Most_Common_Count = sapply(character_vars, function(x) {
      tbl <- table(x)
      if(length(tbl) > 0) max(tbl) else NA
    })
  )
  rownames(character_summary) <- NULL

  character_summary %>%
    kable(digits = 3) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
}
```

## Dimensions

```{r nocov-dimensions}
cat("Number of observations:", nrow(df_nocov), "\n")
cat("Number of variables:", ncol(df_nocov), "\n")
```

## First Few Rows

```{r nocov-head}
head(df_nocov, 10) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  scroll_box(width = "100%")
```

## Variable Distribution

```{r nocov-distributions, fig.width=10, fig.height=8}
# Select numeric variables for plotting
numeric_vars <- df_nocov %>% select(where(is.numeric))

if(ncol(numeric_vars) > 0) {
  numeric_vars %>%
    pivot_longer(everything(), names_to = "variable", values_to = "value") %>%
    ggplot(aes(x = value)) +
    geom_histogram(bins = 30, fill = "darkgreen", alpha = 0.7) +
    facet_wrap(~variable, scales = "free") +
    theme_minimal() +
    labs(title = "Distribution of Numeric Variables (df_design_nocov)")
}
```

## ATT Estimation using Callaway and Sant'Anna (2021)

### Estimate Group-Time ATT (Without Covariates)

```{r nocov-att-estimation}
# Estimate group-time average treatment effects
# No covariates (xformla = ~1 means intercept only)
att_results_nocov <- att_gt(
  yname = "y_it",           # Outcome variable
  tname = "time",            # Time period
  idname = "id",             # Unit identifier
  gname = "group_i",         # Treatment timing (0 for never-treated)
  xformla = ~1,              # No covariates
  data = df_nocov,
  control_group = "nevertreated",  # Use never-treated as comparison
  est_method = "dr"          # Doubly robust estimator
)

# Display summary
summary(att_results_nocov)
```

### Aggregate to Overall ATT

```{r nocov-att-simple}
# Simple weighted average ATT
att_simple_nocov <- aggte(att_results_nocov, type = "simple")
summary(att_simple_nocov)
```

### Event Study / Dynamic Effects

```{r nocov-att-dynamic, fig.width=10, fig.height=6}
# Dynamic treatment effects (event study)
att_dynamic_nocov <- aggte(att_results_nocov, type = "dynamic")
summary(att_dynamic_nocov)

# Plot event study
ggdid(att_dynamic_nocov, title = "Event Study: Dynamic Treatment Effects (No Covariates)")
```

### Group-Specific ATT

```{r nocov-att-group, fig.width=10, fig.height=6}
# Group-specific average treatment effects
att_group_nocov <- aggte(att_results_nocov, type = "group")
summary(att_group_nocov)

# Plot group-specific effects
ggdid(att_group_nocov, title = "Average Treatment Effects by Treatment Cohort (No Covariates)")
```

### Calendar Time Effects

```{r nocov-att-calendar, fig.width=10, fig.height=6}
# Calendar time average treatment effects
att_calendar_nocov <- aggte(att_results_nocov, type = "calendar")
summary(att_calendar_nocov)

# Plot calendar time effects
ggdid(att_calendar_nocov, title = "Average Treatment Effects by Calendar Time (No Covariates)")
```

---

# Dataset 3: NYT Design (df_design_nyt)

## Structure

```{r nyt-structure}
str(df_nyt)
```

## Summary Statistics

### Numeric Variables

```{r nyt-summary-numeric}
numeric_vars <- df_nyt %>% select(where(is.numeric))
if(ncol(numeric_vars) > 0) {
  numeric_summary <- data.frame(
    Variable = names(numeric_vars),
    Min = sapply(numeric_vars, min, na.rm = TRUE),
    Q1 = sapply(numeric_vars, quantile, 0.25, na.rm = TRUE),
    Median = sapply(numeric_vars, median, na.rm = TRUE),
    Mean = sapply(numeric_vars, mean, na.rm = TRUE),
    Q3 = sapply(numeric_vars, quantile, 0.75, na.rm = TRUE),
    Max = sapply(numeric_vars, max, na.rm = TRUE),
    SD = sapply(numeric_vars, sd, na.rm = TRUE),
    N_Missing = sapply(numeric_vars, function(x) sum(is.na(x)))
  )
  rownames(numeric_summary) <- NULL

  numeric_summary %>%
    kable(digits = 3) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
}
```

### Logical Variables

```{r nyt-summary-logical}
logical_vars <- df_nyt %>% select(where(is.logical))
if(ncol(logical_vars) > 0) {
  logical_summary <- data.frame(
    Variable = names(logical_vars),
    N_TRUE = sapply(logical_vars, function(x) sum(x, na.rm = TRUE)),
    N_FALSE = sapply(logical_vars, function(x) sum(!x, na.rm = TRUE)),
    N_Missing = sapply(logical_vars, function(x) sum(is.na(x))),
    Prop_TRUE = sapply(logical_vars, function(x) mean(x, na.rm = TRUE))
  )
  rownames(logical_summary) <- NULL

  logical_summary %>%
    kable(digits = 3) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
}
```

### Character Variables

```{r nyt-summary-character}
character_vars <- df_nyt %>% select(where(is.character))
if(ncol(character_vars) > 0) {
  character_summary <- data.frame(
    Variable = names(character_vars),
    N_Unique = sapply(character_vars, function(x) length(unique(x))),
    N_Missing = sapply(character_vars, function(x) sum(is.na(x) | x == "")),
    Most_Common = sapply(character_vars, function(x) {
      tbl <- table(x)
      if(length(tbl) > 0) names(tbl)[which.max(tbl)] else NA
    }),
    Most_Common_Count = sapply(character_vars, function(x) {
      tbl <- table(x)
      if(length(tbl) > 0) max(tbl) else NA
    })
  )
  rownames(character_summary) <- NULL

  character_summary %>%
    kable(digits = 3) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
}
```

## Dimensions

```{r nyt-dimensions}
cat("Number of observations:", nrow(df_nyt), "\n")
cat("Number of variables:", ncol(df_nyt), "\n")
```

## First Few Rows

```{r nyt-head}
head(df_nyt, 10) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  scroll_box(width = "100%")
```

## Variable Distribution

```{r nyt-distributions, fig.width=10, fig.height=8}
# Select numeric variables for plotting
numeric_vars <- df_nyt %>% select(where(is.numeric))

if(ncol(numeric_vars) > 0) {
  numeric_vars %>%
    pivot_longer(everything(), names_to = "variable", values_to = "value") %>%
    ggplot(aes(x = value)) +
    geom_histogram(bins = 30, fill = "coral", alpha = 0.7) +
    facet_wrap(~variable, scales = "free") +
    theme_minimal() +
    labs(title = "Distribution of Numeric Variables (df_design_nyt)")
}
```

## ATT Estimation using Callaway and Sant'Anna (2021)

### Estimate Group-Time ATT (Not-Yet-Treated Control)

```{r nyt-att-estimation}
# Estimate group-time average treatment effects
# Using not-yet-treated as control (no never-treated group available)
att_results_nyt <- att_gt(
  yname = "y_it",           # Outcome variable
  tname = "time",            # Time period
  idname = "id",             # Unit identifier
  gname = "group_i",         # Treatment timing (no 0 group in this dataset)
  xformla = ~x1_i + x2_i,    # Covariates
  data = df_nyt,
  control_group = "notyettreated",  # Use not-yet-treated as comparison
  est_method = "dr"          # Doubly robust estimator
)

# Display summary
summary(att_results_nyt)
```

### Aggregate to Overall ATT

```{r nyt-att-simple}
# Simple weighted average ATT
att_simple_nyt <- aggte(att_results_nyt, type = "simple")
summary(att_simple_nyt)
```

### Event Study / Dynamic Effects

```{r nyt-att-dynamic, fig.width=10, fig.height=6}
# Dynamic treatment effects (event study)
att_dynamic_nyt <- aggte(att_results_nyt, type = "dynamic")
summary(att_dynamic_nyt)

# Plot event study
ggdid(att_dynamic_nyt, title = "Event Study: Dynamic Treatment Effects (NYT Design)")
```

### Group-Specific ATT

```{r nyt-att-group, fig.width=10, fig.height=6}
# Group-specific average treatment effects
att_group_nyt <- aggte(att_results_nyt, type = "group")
summary(att_group_nyt)

# Plot group-specific effects
ggdid(att_group_nyt, title = "Average Treatment Effects by Treatment Cohort (NYT Design)")
```

### Calendar Time Effects

```{r nyt-att-calendar, fig.width=10, fig.height=6}
# Calendar time average treatment effects
att_calendar_nyt <- aggte(att_results_nyt, type = "calendar")
summary(att_calendar_nyt)

# Plot calendar time effects
ggdid(att_calendar_nyt, title = "Average Treatment Effects by Calendar Time (NYT Design)")
```

---

# Dataset Comparison

## Size Comparison

```{r comparison-size}
data.frame(
  Dataset = c("df_design_cov", "df_design_nocov", "df_design_nyt"),
  Observations = c(nrow(df_cov), nrow(df_nocov), nrow(df_nyt)),
  Variables = c(ncol(df_cov), ncol(df_nocov), ncol(df_nyt))
) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

## Variable Names Comparison

```{r comparison-vars}
data.frame(
  df_design_cov = names(df_cov) %>% paste(collapse = ", "),
  df_design_nocov = names(df_nocov) %>% paste(collapse = ", "),
  df_design_nyt = names(df_nyt) %>% paste(collapse = ", ")
) %>%
  pivot_longer(everything(), names_to = "Dataset", values_to = "Variables") %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

# Conclusion

This report provides a comprehensive description of the three difference-in-differences multi-period datasets. Each dataset has been examined for its structure, summary statistics, dimensions, and variable distributions.
