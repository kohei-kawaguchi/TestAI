---
title: "Randomization Inference and Fisher's Exact P-value"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
```

## Load Data

```{r load-data}
data <- readRDS(here("output/randomization_fisher_pvalue/data_realized.rds"))
```

## Data Description

```{r data-description}
# Display data structure
str(data)

# Display first few rows
head(data)
```

The dataset contains `r nrow(data)` observations and `r ncol(data)` variables.

### Variable Summary

```{r variable-summary}
# Create summary statistics table
library(knitr)

# Function to get variable type
get_var_type <- function(x) {
  class(x)[1]
}

# Function to create summary for a variable
create_var_summary <- function(var_name, var_data) {
  data.frame(
    Variable = var_name,
    Type = get_var_type(var_data),
    Min = min(var_data),
    Q1 = quantile(var_data, 0.25),
    Median = median(var_data),
    Mean = mean(var_data),
    Q3 = quantile(var_data, 0.75),
    Max = max(var_data),
    SD = sd(var_data)
  )
}

# Create summary for all variables
summary_table <- do.call(rbind, lapply(names(data), function(var_name) {
  create_var_summary(var_name, data[[var_name]])
}))

kable(summary_table, digits = 3, caption = "Summary Statistics of Variables")
```

## Average Treatment Effect Estimation

The variable `y` is an outcome variable and `z` is a binary treatment variable that is randomly assigned. Under random assignment, the average treatment effect (ATE) can be estimated by calculating the difference in means of `y` between the treated group (`z=1`) and control group (`z=0`).

```{r ate-estimation}
# Calculate mean outcomes by treatment group
mean_treated <- mean(data$y[data$z == 1])
mean_control <- mean(data$y[data$z == 0])

# Estimate average treatment effect
ate <- mean_treated - mean_control

cat("Mean outcome (treated group):", round(mean_treated, 3), "\n")
cat("Mean outcome (control group):", round(mean_control, 3), "\n")
cat("Average Treatment Effect (ATE):", round(ate, 3), "\n")
```

## Standard Error of the ATE

The standard error of the ATE can be estimated using the Neyman standard error formula:

$$SE(\hat{ATE}) = \sqrt{\frac{s_1^2}{n_1} + \frac{s_0^2}{n_0}}$$

where $s_1^2$ and $s_0^2$ are the sample variances in the treated and control groups, and $n_1$ and $n_0$ are the sample sizes.

```{r ate-se}
# Calculate sample sizes
n_treated <- sum(data$z == 1)
n_control <- sum(data$z == 0)

# Calculate sample variances
var_treated <- var(data$y[data$z == 1])
var_control <- var(data$y[data$z == 0])

# Calculate standard error
se_ate <- sqrt(var_treated / n_treated + var_control / n_control)

cat("Sample size (treated):", n_treated, "\n")
cat("Sample size (control):", n_control, "\n")
cat("Variance (treated):", round(var_treated, 3), "\n")
cat("Variance (control):", round(var_control, 3), "\n")
cat("Standard Error of ATE:", round(se_ate, 3), "\n")
```

### Properties of the Neyman Standard Error Estimator

Under random assignment of treatment with the following assumptions:

1. **No interference**: Potential outcomes are independent across units
2. **Large sample approximation**: The Central Limit Theorem applies as sample size increases

The Neyman standard error estimator is consistent (i.e., converges to the true standard error as sample size goes to infinity).

**Finite Sample Bias**: In finite samples, the Neyman estimator is **conservatively biased** (upwardly biased), meaning it tends to overestimate the true standard error. This occurs because:

1. Treatment assignment is not independent in finite samplesâ€”in a completely randomized experiment, knowing some assignments provides information about others
2. The standard formula omits a covariance term between potential outcomes that would reduce the variance
3. The estimator is unbiased under constant treatment effects, but conservatively biased when treatment effects are heterogeneous

This conservative bias makes the estimator useful for hypothesis testing, as it errs on the side of caution.
```